<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="js/toast.js" defer></script>
  <script src="js/validation.js" defer></script>
  <title>Login | Samyak Ayurvedic Hospital</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="styles/tokens.css">

  <style>
    /* CSS Variables for Theme System */
    :root {
      /* Light Mode (Default) */
      --bg-main: rgba(255, 255, 255, 0.82);
      --bg-body: url("assets/hero.jpg") center/cover no-repeat fixed;
      --bg-card: #fff;
      --bg-sidebar: #fff;
      --bg-input: #fff;
      --bg-modal: rgba(0, 0, 0, 0.4);

      --bg-primary: #155c3b;
      --bg-primary-hover: #0d462b;
      --bg-secondary: #eaf4ee;
      --bg-tertiary: #f3f8f5;
      --bg-muted: #f8fbf9;

      --text-primary: #155c3b;
      --text-secondary: #4f6f60;
      --text-muted: #6b8a7a;
      --text-dark: #2c3e50;
      --text-label: #7f9f8e;
      --text-white: #fff;

      --border-light: #eaf4ee;
      --border-muted: #f3f8f5;
      --border-subtle: #ddd;

      --shadow-card: 0 22px 46px rgba(0, 0, 0, 0.2);
      --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.05);
      --shadow-hover: 0 10px 25px rgba(21, 92, 59, 0.1);
    }


    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: var(--bg-body);
      transition: background-color 0.3s ease;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-main);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }

    .container {
      position: relative;
      z-index: 2;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 420px;
      background: var(--bg-card);
      border-radius: 22px;
      padding: 36px;
      box-shadow: var(--shadow-card);
      animation: fadeIn .4s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(12px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    .back {
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 18px;
      display: inline-block;
      text-decoration: none;
    }

    .logo {
      width: 46px;
      display: block;
      margin: 0 auto 12px;
    }

    h2 {
      text-align: center;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    p {
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 22px;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 30px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-input);
      color: var(--text-dark);
      margin-bottom: 14px;
      font-size: 14px;
    }

    button.primary {
      width: 100%;
      padding: 13px;
      border-radius: 30px;
      border: none;
      background: var(--bg-primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: .3s;
    }

    button.primary:hover {
      background: var(--bg-primary-hover);
      transform: translateY(-2px);
    }

    /* GOOGLE */
    .google-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 16px;
      padding: 12px;
      border-radius: 30px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-card);
      color: var(--text-dark);
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
    }

    .google-btn:hover {
      text-decoration: none;
    }

    .google-btn img {
      width: 18px
    }

    .or {
      text-align: center;
      margin: 16px 0;
      color: var(--text-muted);
      font-size: 13px;
    }

    .switch {
      text-align: center;
      font-size: 14px;
      margin-top: 14px;
    }

    .switch a {
      color: var(--text-primary);
      font-weight: 600;
      text-decoration: none;
    }

    .notice {
      background: var(--bg-muted);
      border: 1px solid var(--border-light);
      color: var(--text-dark);
      padding: 12px 14px;
      border-radius: 10px;
      margin-bottom: 14px;
      display: none;
      text-align: center;
    }

    .notice a {
      display: inline-block;
      margin-top: 8px;
      padding: 8px 14px;
      background: var(--bg-primary);
      color: #fff;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>

<body>

  <div class="overlay"></div>

  <div class="container">
    <div class="card">

      <a href="index.html" class="back">‚Üê Back</a>

      <img src="assets/logo.png" class="logo" alt="Samyak Ayurvedic Hospital Logo">

      <h2 id="title">Patient Login</h2>
      <p id="subtitle">Login to manage your appointments</p>

      <div id="noUserNotice" class="notice">
        <div id="noUserText">No user found for this Google account.</div>
        <a id="goActivate" href="#">Activate</a>
      </div>

      <form id="loginForm">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <div style="text-align: right; margin-bottom: 14px;">
          <a href="forgot-password.html"
            style="color: var(--text-primary); text-decoration: none; font-size: 13px; font-weight: 500;">Forgot
            Password?</a>
        </div>
        <button type="submit" class="primary">Login</button>
      </form>

      <div id="googleSection">
        <div class="or">OR</div>

        <a href="http://localhost:5001/api/auth/google" class="google-btn">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Logo">
          Continue with Google
        </a>

        <p class="switch">
          New patient? <a href="activate.html">Activate Account</a>
        </p>
      </div>

    </div>
  </div>

  <script>
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      // üî• Detect role from URL
      const params = new URLSearchParams(window.location.search);
      const role = params.get("role") || "patient"; // default patient

      const url = role === "doctor" ? "http://localhost:5001/api/doctors/login" : "http://localhost:5001/api/users/login";

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          email,
          password,
          role
        })
      });

      const data = await res.json();

      if (!data.success) {
        window.showToast("error", data.message);
        return;
      }

      // ‚úÖ Save auth
      localStorage.setItem("token", data.token);
      // normalize user object with `name` for frontend
      const userObj = Object.assign({}, data.user, {
        name: (data.user.firstName || "") + (data.user.lastName ? " " + data.user.lastName : "")
      });
      localStorage.setItem("user", JSON.stringify(userObj));
      localStorage.setItem("userId", data.user._id || data.user._id);
      localStorage.setItem("role", data.user.role || role);

      // üîÄ Redirect based on role
      if (role === "doctor") {
        window.location.href = "doctor-dashboard.html";
      } else {
        window.location.href = "patient-dashboard.html";
      }
    });
  </script>
  <script>
    // Adjust UI based on role (show doctor UI, hide Google for doctors)
    (() => {
      const params = new URLSearchParams(window.location.search);
      const role = params.get("role") || "patient";
      const title = document.getElementById("title");
      const subtitle = document.getElementById("subtitle");
      const googleSection = document.getElementById("googleSection");

      if (role === "doctor") {
        title.innerText = "Doctor Login";
        subtitle.innerText = "Doctor dashboard access";
        if (googleSection) googleSection.style.display = "none";
      }
    })();
  </script>
  <script>
    // Show friendly notice when Google-authenticated account isn't registered
    (function () {
      const params = new URLSearchParams(window.location.search);
      if (params.get("error") === "no_user_found") {
        const notice = document.getElementById("noUserNotice");
        const btn = document.getElementById("goActivate");
        const email = params.get("email");
        const name = params.get("name");

        if (email) {
          // prefill email field but keep editable
          const emailInput = document.getElementById("email");
          emailInput.value = decodeURIComponent(email);
        }

        // link to register with prefilled info
        const regParams = new URLSearchParams();
        regParams.set("google", "true");
        if (email) regParams.set("email", email);
        if (name) regParams.set("name", name);
        btn.href = `activate.html?${regParams.toString()}`;

        notice.style.display = "block";
      }
    })();
  </script>

</body>

</html>